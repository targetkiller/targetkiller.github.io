<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>H5动感影集性能分析 | TQ blog</title>
  <meta name="description" content="No one is king for long" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" href="http://storyincafe.com/tqtan.jpg">
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <meta name="generator" content="TQ blog">

  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="atom.xml">
  
  
</head>

<body class="home-template">
<div id="perspective" class="perspective effect-movedown">
  <div class="container">
    <!-- wrapper -->
    <div class="wrapper">

      <header class="site-head"  style="background: #24282b url(/img/img-bg.jpg) 0 -20%" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/logo.png" alt="Blog Logo"/></a> 
            <h1 class="blog-title">No one is king for long</h1>
            <h2 class="blog-description">
                <a href="http://targetkiller.lofter.com/">摄影集</a> /
                <a href="https://github.com/targetkiller">代码集</a> /
                <a href="https://about.me/targetkiller">关于我</a>
                <button id="showMenu" style="display:none;">Show Menu</button>
            </h2>
        </div>
    </div>
</header>

      

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2015-11-25T16:25:54.000Z" itemprop="datePublished">
          2015-11-26
      </time>
    
    
    | 
    <a href='/tags/前端/'>前端</a>,
    
    <a href='/tags/HTML5/'>HTML5</a>,
    
    <a href='/tags/开发者工具/'>开发者工具</a>,
    
    <a href='/tags/性能分析/'>性能分析</a>
    
    
</span>
    <h1 class="post-title">H5动感影集性能分析</h1>
    <section class="post-content">
      <p><em>“你听说过动感影集么?”</em></p>
<p><strong><code>动感影集</code></strong>是QQ空间新功能，可以将静态的图片轻松转变为动态的视频集，且载体是HTML5（简称H5）页面，意味着可以随时分享到空间或朋友圈给好友欣赏！<br><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151124192906_Dljw4gKEmH.png" alt></p>
<p>移动端区别于PC年代的相册视频，由于设备性能限制，每一个动画细节都需要认真优化，今天就来说说动感影集开发过程中的<strong>动画性能检测与优化</strong>的问题。</p>
<h3 id="1-先利其器-Chrome-Timeline-amp-Rendering"><a href="#1-先利其器-Chrome-Timeline-amp-Rendering" class="headerlink" title="1.先利其器 - Chrome Timeline&amp;Rendering"></a>1.先利其器 - Chrome Timeline&amp;Rendering</h3><p>性能分析前，我们先看看工具。Chrome浏览器带来的两个工具是发现性能问题的利器，它们是<code>Timeline</code>和<code>Rendering</code>。</p>
<blockquote>
<p>Timeline</p>
</blockquote>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151124192810_CB3Ah8MhMJ.png" alt></p>
<p><strong>Timeline</strong>是一款基于录制的工具，通过录制在浏览器中的一系列操作，系统会记录这个过程的所有细节数据，包括js计算、页面重绘、复合层消耗等，同时还保存着这个过程每一帧的截图。</p>
<p><strong>使用方法：</strong>打开Chrome开发者工具，选择Timeline。点击左上角小圆点录制操作，然后在要检测的页面上做一系列交互操作，结束后再次点击圆点停止，最后操作期间的一系列数据就会以图表等的形式呈现在面板中。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151124195608_svDLIrgx88.png" alt></p>
<p>它有四种事件，对应四个颜色。如下图，网络和DOM解析(蓝色)，JavaScript计算(黄色)，样式重计算和布局(紫色)以及绘画和合成(绿色)事件。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151124200344_afTsE0FIvR.png" alt></p>
<p>它有三个模式：<code>帧模式</code>、<code>事件模式</code>和<code>内存模式</code>。</p>
<p>（1）帧模式<br>帧模式需要选中帧视图(柱形图按钮)开启。该模式是检查动画性能最常用的模式。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151124202107_HGr89KHfMj.png" alt></p>
<p>注意到，帧查看器有两条分界线，分别是30fps和60fps。</p>
<p>这需要我们重温<strong>fps（每秒传输帧数）</strong>的概念：</p>
<ul>
<li>若动画表现fps大于60，则超越了人眼能反映的刷新频率；</li>
<li>如果fps小于30，则卡顿明显；</li>
</ul>
<p>也就是说fps要保证接近60才能保证流畅。<a href="http://www.30vs60fps.com/" target="_blank" rel="noopener">点击这里</a>可以看到30fps和60fps的明显区别。回归到帧模式柱状图，不难看出柱状图<strong>柱高越小表示动画越流畅</strong>。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151124203636_oollqmjylV.jpg" alt></p>
<p>同时通过点击柱状图还可以看到CPU、内存的详情，以及找到对应脚本和结点定位。</p>
<p><strong>基本用法：</strong></p>
<ul>
<li>点击录制-&gt;开始页面动画-&gt;结束录制</li>
<li>通过查看柱状图记录出哪些柱比较高（性能差）</li>
<li>点击柱图定位事件记录，结合详情数据找出性能卡顿的原因</li>
</ul>
<p>（2）事件模式和内存模式</p>
<p><strong>事件模式</strong>需要点击事件按钮开启（如图左侧蓝色），而<strong>内存模式</strong>是可以同时显示在帧模式或事件模式中，只需要勾选Memory面板即可。<br><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151124203918_wk5hzZFOwo.png" alt></p>
<p>事件模式是以事件为导向，观察录制间操作的事件经过，方便定位哪个操作占用的事件比较频繁。同时结合内存面板，可以看得出哪个事件消耗的内存最大，有没有合理地进行垃圾回收（GC）。</p>
<p>同时注意到这里勾选了<strong>Screenshots面板</strong>，这个面板记录了过程间的屏幕截图，更方便定位有性能问题的操作区间，发现问题所在。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151124205108_DVYDW7jy26.png" alt></p>
<blockquote>
<p>Rendering</p>
</blockquote>
<p>Rendering处于开发者工具的隐藏面板中，打开Chrome开发者工具然后按ESC键打开。<br><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125101219_9Zk4f9fISW.png" alt></p>
<p>它有四个功能：</p>
<ul>
<li><p><code>开启绘制闪烁提示</code>。这功能会让页面在渲染的时候闪烁绿色，你可以借此增删元素查看哪些元素是绘制消耗最大的。（该功能替代了旧版的Show paint rectangles+Enable continuous page repainting，Chrome46。）<br><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125112425_qKcDzhMuY6.png" alt></p>
</li>
<li><p><code>显示层块边框</code>。这功能会让所有层块元素展示黄色的边框，可以方便定位元素的布局是否合理。<br><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125112425_waJF7yvaQR.png" alt></p>
</li>
<li><p><code>显示FPS计量器</code>。这功能会在页面右上角展示一个FPS计量器，实时展示FPS数，可以方便地在做一系列操作的时候发现性能瓶颈卡在哪里。<br><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125112425_3hJRHFikFs.png" alt></p>
</li>
<li><p><code>展示滚动表现</code>。这功能是使页面滚动变得缓慢，对触摸和滚动事件的监听会使滚动延迟，可以通过这个功能查看滚动时期的瓶颈。<br><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125112425_Q8LyayMtNp.png" alt></p>
</li>
</ul>
<h3 id="2-洞察技巧-如何发现性能问题"><a href="#2-洞察技巧-如何发现性能问题" class="headerlink" title="2.洞察技巧 - 如何发现性能问题"></a>2.洞察技巧 - 如何发现性能问题</h3><p>上面说了性能分析的工具，下面应该说说检测动画性能问题的办法。动画性能分析主要用到Timeline<strong>帧模式</strong>+Rendering的<strong>开启绘制闪烁</strong>和<strong>显示层级边框</strong>功能。</p>
<blockquote>
<p>用法1：检查卡顿情况</p>
</blockquote>
<p>打开帧模式，点击录制按钮，开始录制页面操作，之后结束录制，查看柱状图。发现低于60fps的柱形，点击具体的帧率柱，查看记录详情，根据左边的信息定位问题所在，如下图：</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125155232_U9DhymwsNq.png" alt></p>
<blockquote>
<p>用法2：查看层级与多余布局块</p>
</blockquote>
<p>有时候感觉页面卡，可能会是因为层块多没有处理好显隐。可以通过功能面板的paint选项卡开启渲染截图。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125155630_pYaH7WsOv2.png" alt></p>
<p>该功能开启后，再次录制操作，结束后可以在<code>详细数据面板</code>看到每一个柱形图的即时渲染截图，通过移动和查找可以看出哪些块是不应该出现的，从而把它解决掉。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125155631_NE5KsOsXaF.png" alt></p>
<blockquote>
<p>用法3：查看多余或重复渲染的结点</p>
</blockquote>
<p>勾选Rendering中的Enable paint flashing和Show layer borders。直接操作页面，可以看到操作期间是否会有意料之外的块状渲染（渲染的结点会呈现绿色框框），若有问题则删除多余结点再次尝试，逐渐定位出有问题的结点。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125160704_xCODeW5Rte.png" alt></p>
<p><em>以上三个功能可以帮助你发现很多性能的问题。</em></p>
<h3 id="3-江湖事迹-动感影集性能案例"><a href="#3-江湖事迹-动感影集性能案例" class="headerlink" title="3.江湖事迹 - 动感影集性能案例"></a>3.江湖事迹 - 动感影集性能案例</h3><p>说了那么多，现在就来分享三个开发过程中的简单性能案例。</p>
<blockquote>
<p>1.封尾扩散动画</p>
</blockquote>
<p>动感影集的封尾页会用到一个通用的页尾，动画很简单，是一个圈圈由中间向两边扩散。实现也很快，马上会想到border动画，把border由0px-&gt;1000px，在PC看没问题，于是就有了这个。<br><img src="http://i5.tietuku.com/a9c1fae778f4553e.gif" alt></p>
<p>但是，在小米2S看的时候就发现结束的时候十分卡，看了下前面的元素都是渐现动画，不可能呀，于是用Timeline工具分析了一下。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125200336_kGST6QzwaK.png" alt></p>
<p>各种绿色！说明是painting（渲染）引起的性能问题，因此毫无疑问是动画原因了。同时我还看了下Paint面板：</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125200336_PquXVX1PsL.png" alt></p>
<p>发现了一个十分大的层在绘制（绿色部分），发现是bg-border这个结点的问题。于是我查看了该结点的动画：</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125200358_VWTK07dHQQ.png" alt></p>
<p>会不会就是这个结点的border动画引起的？那试试换一种写法，我把border值固定，通过transform:scale来改变大小，实现了一样的效果。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125200359_XSjxhbSeIn.png" alt></p>
<p>再看看timeline？</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125200336_JUyGU1eF5m.png" alt></p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125202220_GvDzOgXiRS.png" alt></p>
<p>O.M.G！除了刚开始绘制的消耗外，其他时候已经不会产生太多严重消耗，总体FPS维持在60以上（十分流畅），而且层的大小也自然降了下来。</p>
<p><strong>结论：</strong> border动画在低端机器可能会产生性能问题，看情况使用其他方式代替。</p>
<blockquote>
<p>2.前景放大动画</p>
</blockquote>
<p>在邀请函模板里有一个前景由小变大的动画，但是在安卓机上产生了严重的渲染异常，如下图：</p>
<p><img src="http://i5.tietuku.com/2849791fdf2d159d.gif" alt></p>
<p>在IOS机器上没有重现，循例我查看了timeline。发现上面也没有异样，性能还是能保持流畅。那么问题出在哪里呢？</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125200336_pmfKhcUkOs.png" alt></p>
<p>我查看了这区域的代码，这里是一个影集间的相片切换效果，其中上一个效果结束会加上一个.animate-b的类，作用了这个类将会有一个渐隐的动画；与此同时新的页只要加上.animate类就开始播放。这是通过js控制两个类来实现不同类型动画的切换。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125200359_YCEuHhahlp.png" alt></p>
<p>那么问题是否出在这里呢？于是我把渐隐动画去掉，播放完的页面直接隐藏掉，不让动画播放，然后新动画调整到直接播放不渐现的效果。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125200359_pKsgSyoszY.png" alt></p>
<p>最后发现，问题解决了！效果如图：</p>
<p><img src="http://i5.tietuku.com/99efe8cd0f84d559.gif" alt></p>
<p><strong>结论：</strong> 背后的动画可能会影响当前动画的播放，在安卓4.0系统都会产生渲染异常的问题，因此应该把不在当前播放的动画停掉。</p>
<blockquote>
<p>3.安卓逐帧渲染bug</p>
</blockquote>
<p>更多的性能问题都不会产生严重的表现，最多是一点卡顿。但是安卓4.0的渲染异常却是常会出现，为此我再找一个例子。以下是我做万圣节活动的时候发现的一个问题，具体表现直接上图：</p>
<p><img src="http://i5.tietuku.com/a5f8259b1854243f.gif" alt></p>
<p>这是魅族比较好的一台机器，但依然会产生逐帧渲染问题。<br>根据之前的例子，我第一时间会想到是否别的动画在影响？我看到这个动画作用钱有一个手一直摇一摇的动画，而且发现摇完后那个动画在背后是循环播放（infinite）的，一直没有结束。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125200359_qUHAiW2AOc.png" alt></p>
<p>心想，只能是它了，于是我把它去掉：</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125200359_WyaTSZNmFS.png" alt></p>
<p>结果如我所想，页面终于流畅了：</p>
<p><img src="http://i5.tietuku.com/b1562b5528fa526d.gif" alt></p>
<p><strong>总结：</strong> 在性能检测的时候，有时候工具并不能帮到你，在找问题的时候也不要一味在当前页面找，很有可能是背后的一些无关代码在做着别的消耗性行为，因此在找不到问题的时候不妨从当前页的上下游入手。</p>
<h3 id="4-熟能生巧-性能优化的经验技巧"><a href="#4-熟能生巧-性能优化的经验技巧" class="headerlink" title="4.熟能生巧 - 性能优化的经验技巧"></a>4.熟能生巧 - 性能优化的经验技巧</h3><p>说了一些具体操作办法，最后来说一下我在开发过程中积累的经验。</p>
<blockquote>
<p>1.以下属性的更优解决方案</p>
</blockquote>
<p>左侧属性都很有可能会带来性能问题。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125163438_L12dD8en8M.png" alt></p>
<blockquote>
<p>2.动画坑点</p>
</blockquote>
<ul>
<li><p><strong>兄弟元素间动画互相影响</strong><br>当前播放的动画会因为其他结点动画还没结束而收到影响，安卓机器上会呈现逐帧渲染的表现。<br><code>解决办法</code>：处可视区域播放的动画外，将背后播放的动画display:none或者animation-play-state:pause。</p>
</li>
<li><p><strong>z-index设置不当</strong><br>兄弟元素在复合层中渲染，且z-index比主元素小，则主元素也会被加入到复合层渲染。<a href="http://div.io/topic/1348" target="_blank" rel="noopener">有篇文章</a>就是说这个问题。<br><code>解决办法</code>：给作用于动画的兄弟元素设置合理z-index值。</p>
</li>
</ul>
<blockquote>
<p>3.巧妙使用css动画</p>
</blockquote>
<p>这是一些用CSS3来解决一般JS效果的做法。</p>
<p><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125180542_lBifVRPPp3.png" alt><br><img src="http://qzonestyle.gtimg.cn/aoi/sola/20151125180542_CW2h7XMjmn.png" alt></p>
<blockquote>
<p>4.是否都要GPU加速？</p>
</blockquote>
<p>最后，讨论一下这个问题。开启GPU加速固然会让页面动画更流畅，但是否表示所有元素都要开启？肯定不是，会有以下几个缺点：</p>
<ul>
<li>盲目使用会让无关元素都渲染成复合层。</li>
<li>复合层渲染成位图消耗内存，也会耗时。</li>
<li>移动端手机会因此电量消耗更快。</li>
</ul>
<p>由此可见，如果使用GPU的元素很多，那么内存的消耗可能就远远大于动画的消耗，这就有点本末倒置了。因此，最好的办法是<strong>处理好动画层级，整合动画层一并开启GPU加速</strong>。</p>
<p>以上，感谢阅读，欢迎留言讨论。</p>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>tqtan</h4>
    <p>UI开发工程师／腾讯WXG，喜欢玩技术，也喜欢拍照。</p>
</section>
      <section class="share">
    <h4>Contact me</h4>
    <a class="icon-instagram" title="Instagram:targetkiller_" href="http://instagram.com/targetkiller_" target="_blank">
    <span class="hidden">instagram</span>
    </a>
    <a class="icon-sina-weibo" title="新浪微博" href="http://weibo.com/targetkiller" target="_blank">
    <span class="hidden">weibo</span>
    </a>
    <a class="icon-facebook" title="facebook" target="_blank" href="https://www.facebook.com/tq.targetkiller">
    <span class="hidden">facebook</span>
    </a>
    <a class="icon-github" title="Github" target="_blank" href="https://github.com/targetkiller">
    <span class="hidden">facebook</span>
    </a>
</section>

    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/2016/01/01/summary-2015/">
        ← 2015年终总结
    </a>
    
    <span class="icon-logo">•</span>
    
    <a class="older-posts" href="/2015/01/31/play-with-h5/">
        玩转HTML5移动页面 →
    </a>
    
</nav>

  <div id="comment" class="comments-area">
    <h4 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h4>
    
</div>

</main>


      
<footer class="site-footer">
  
  <a class="subscribe icon-feed" href="atom.xml"><span class="tooltip">Subscribe!</span></a>
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">TQ blog</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

      <script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>




  </div>
</div>

<nav  class="outer-nav top horizontal">

          <a class="icon-home"  href="/"><span>Home</span></a>

          <a class="icon-news"  href="/archive"><span>Archive</span></a>

          <a class="icon-image"  href="/images"><span>Images</span></a>

          <a class="icon-wiki"  href="/wiki/2014-10-28-wiki/"><span>Wiki</span></a>

          <a class="icon-Favorites"  href="/favorites"><span>Favorites</span></a>

          <a class="icon-mail"  href="/about/2014-09-11-mabao/"><span>Contact</span></a>

</nav>

</div>
</body>
</html>
