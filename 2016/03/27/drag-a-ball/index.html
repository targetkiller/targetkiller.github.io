<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>拖拽粘性小红球Canvas实现 | TQ blog</title>
  <meta name="description" content="No one is king for long" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <meta name="generator" content="TQ blog">

  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="atom.xml">
  
  
</head>

<body class="home-template">
<div id="perspective" class="perspective effect-movedown">
  <div class="container">
    <!-- wrapper -->
    <div class="wrapper">

      <header class="site-head"  style="background: #24282b url(/img/img-bg.jpg) 0 -20%" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/logo.png" alt="Blog Logo"/></a> 
            <h1 class="blog-title">No one is king for long</h1>
            <h2 class="blog-description">
                <a href="http://targetkiller.lofter.com/">摄影集</a> /
                <a href="https://github.com/targetkiller">代码集</a> /
                <a href="https://about.me/targetkiller">关于我</a>
                <button id="showMenu" style="display:none;">Show Menu</button>
            </h2>
        </div>
    </div>
</header>

      

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2016-03-27T09:15:21.000Z" itemprop="datePublished">
          2016-03-27
      </time>
    
    
    | 
    <a href='/tags/前端/'>前端</a>,
    
    <a href='/tags/教程/'>教程</a>,
    
    <a href='/tags/demo/'>demo</a>,
    
    <a href='/tags/canvas/'>canvas</a>
    
    
</span>
    <h1 class="post-title">拖拽粘性小红球Canvas实现</h1>
    <section class="post-content">
      <p>相信大家都见过之前手机QQ中神奇的“<a href="https://isux.tencent.com/qq-mobile-off-duty.html" target="_blank" rel="noopener">一键下班</a>”功能，如图：</p>
<p><img src="http://storyincafe.com/blogpics/drag-a-ball-1.png" alt="一键下班示意图"></p>
<p>它通过一种优雅的方式，去掉QQ上的所有消息通知红点：用户可以拖拽粘性的小球来删除红点，动画符合用户心理预期。详情请看<a href="(https://isux.tencent.com/qq-mobile-off-duty.html">ISUX文章</a>介绍，本文借鉴于此。</p>
<p>这个创意十分棒，但是它是基于客户端实现的。对于这个带粘性的弹性小球其实可以用在很多方面，例如loading动画、下拉刷新提示、横屏提示、按钮反馈等等，因此有必要实现一个前端版本。<br><small style="color:#999;">没错，这是一个教程贴，客官按需往下看。</small></p>
<p>那么先看看效果：<a href="http://storyincafe.com/drag-a-ball.html" target="_blank" rel="noopener">点击demo</a>，打开后试试拖拉小球儿，也可以点击左上角的辅助线看看小球的轨迹～<br><small style="color:#999;">(请用手机查看)</small></p>
<p><img src="http://storyincafe.com/blogpics/drag-a-ball-2.png" alt="粘性小球拖拽效果"></p>
<h3 id="开始动手"><a href="#开始动手" class="headerlink" title="开始动手"></a>开始动手</h3><blockquote>
<p>生成小球</p>
</blockquote>
<p>这是最简单的一步，只需要用到<code>Canvas.arc(x,y,radius,start_angle,end_angle)</code>这一个方法，绘制一个小圆点位于画布中心，作为今天的主角。</p>
<blockquote>
<p>监听方法</p>
</blockquote>
<p>拖拽的过程需要用到移动端的touch事件，分别需要监听拖拽前、中、后三个过程。</p>
<figure class="highlight"><pre><font face="monospace">canvas.addEventListener(&apos;touchstart&apos;,dragStart);
canvas.addEventListener(&apos;touchmove&apos;,draging);
canvas.addEventListener(&apos;touchstart&apos;,dragEnd);
</font></pre></figure>

<blockquote>
<p>拖拽前DragStart</p>
</blockquote>
<p>由于采用Canvas实现，监听都是绑定在整个画布上，因此需要实时判断开始拖拽的时候手指是否按在小球上。</p>
<p>这里需要用到两点间距离公式：</p>
<div style="width:300px;">![两点间距离公式](http://storyincafe.com/blogpics/drag-a-ball-3.jpg)</div>

<p>获取手指触点的x和y，然后根据公式判断与小球圆点的距离是否大于小圆半径Radius，则可判断是否在小球上。注意这里需要加上一个边缘容差值move_rest，确保手指在边缘也能拖动小球。</p>
<figure class="highlight"><pre><font face="monospace">//&#x8FB9;&#x7F18;&#x5BB9;&#x5DEE;
var move_rest = 20;

//&#x89E6;&#x70B9;&#x5750;&#x6807;
var x = e.touches[0].clientX;
var y = e.touches[0].clientY;

// &#x8BA1;&#x7B97;&#x662F;&#x5426;&#x5728;&#x5706;&#x5185;
var distance = Math.sqrt(Math.pow(x-oX,2)+Math.pow(y-oY,2));

// &#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x5224;&#x65AD;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x62D6;&#x52A8;
is_canMove = (distance-move_rest) &gt; oRadius ? false : true;
</font></pre></figure>

<blockquote>
<p>拖拽时Draging</p>
</blockquote>
<p>拖拽时需要小球伴随着手指的运动而运动，因此需要在手指触点位置绘制一个一摸一样的小球，这跟绘制中心小球一样简单。</p>
<p>然而，如何建立小球和中心小球的联系呢？</p>
<h4 id="方案1"><a href="#方案1" class="headerlink" title="方案1"></a>方案1</h4><p>先建立两者连接，以两圆间相切点连成线，如下图所示：</p>
<div style="max-width:500px;">![拖拽时方案1](http://storyincafe.com/blogpics/drag-a-ball-4.jpg)</div>

<p>这个比较简单，因为拖动夹角固定为90度（两圆平行的切点），获取两圆之间与水平坐标的夹角就可以算出四个切点的坐标，最后再连线就行了。<br>注意这里需要判断拖动的小球相对中心小球处于第几象限，从而确定切点。</p>
<figure class="highlight"><pre><font face="monospace">// &#x8BA1;&#x7B97;&#x4E24;&#x5706;&#x4E4B;&#x95F4;&#x4E0E;&#x6C34;&#x5E73;&#x5750;&#x6807;&#x7684;&#x5939;&#x89D2;
var angle = Math.atan(Math.abs(y - toY)/Math.abs(x - toX));

// &#x8BA1;&#x7B97;&#x56DB;&#x4E2A;&#x5207;&#x70B9;&#x5750;&#x6807;&#xFF0C;&#x62D6;&#x52A8;&#x5706;&#x5706;&#x5FC3;(toX,toY)&#xFF0C;&#x4E2D;&#x5FC3;&#x5706;&#x5706;&#x5FC3;(x,y)&#xFF0C;a&#x4E3A;&#x62D6;&#x52A8;&#x5706;&#x4E24;&#x4E2A;&#x5207;&#x70B9;&#xFF0C;b&#x4E3A;&#x4E2D;&#x5FC3;&#x5706;&#x4E24;&#x4E2A;&#x5207;&#x70B9;

&lt;!-- &#x7B2C;&#x56DB;&#x8C61;&#x9650;&#xFF0C;&#x62D6;&#x52A8;&#x5706;&#x5728;&#x4E2D;&#x5FC3;&#x5706;&#x53F3;&#x4E0B;&#x89D2;&#xFF0C;&#x5176;&#x4ED6;&#x4E09;&#x4E2A;&#x8C61;&#x9650;&#x7C7B;&#x63A8;... --&gt;
var a1x = toX + Math.cos(Math.abs(Math.PI/2))*oRadius;
var a1y = toY - Math.cos(Math.abs(Math.PI/2))*oRadius;
var a2x = toX - Math.cos(Math.abs(Math.PI/2))*oRadius;
var a2y = toY + Math.cos(Math.abs(Math.PI/2))*oRadius;
var b1x = x + Math.cos(Math.abs(Math.PI/2))*oRadius;
var b1y = y - Math.cos(Math.abs(Math.PI/2))*oRadius;
var b2x = x - Math.cos(Math.abs(Math.PI/2))*oRadius;
var b2y = y + Math.cos(Math.abs(Math.PI/2))*oRadius;
</font></pre></figure>

<p>然而，这样无论如何拉伸小圆都是直直的，没有粘性的效果，怎么办呢？</p>
<h4 id="方案2"><a href="#方案2" class="headerlink" title="方案2"></a>方案2</h4><p>想要增加粘性效果，需要把相连的直线改为<a href="http://baike.baidu.com/view/60154.htm" target="_blank" rel="noopener">贝塞尔曲线</a>。</p>
<p>写过CSS动画的人应该都对它不陌生，因为<code>animation-timing-function</code>可以通过定义贝塞尔值来实现动画过程中速率的自由变化。</p>
<p>如图，一条贝塞尔曲线最少由三个点组成，分别是起点P0、终点P3和控制点P1,P2，其中控制点可以有一个或两个。<br><img src="http://storyincafe.com/blogpics/drag-a-ball-5.png" alt="贝塞尔曲线示意图"></p>
<p>对应于Canvas，也有相应的贝塞尔方法：</p>
<ul>
<li><p>一个控制点</p>
<figure class="highlight"><pre><font face="monospace">context.quadraticCurveTo(cpx,cpy,x,y);
</font></pre></figure>
</li>
<li><p>两个控制点</p>
<figure class="highlight"><pre><font face="monospace">context.bezierCurveTo(cp1x,cp1y,cp2x,cp2y,x,y);
</font></pre></figure>

</li>
</ul>
<p>这次我们只需要使用一个控制点，也就是使用<code>quadraticCurveTo</code>方法就可以了。<br>至于如何定义这次的控制点？</p>
<p>如图，我们如果要定目标圆(a1x,a1y)和中心圆(b1x,b1y)的控制点，就以目标圆另一个点(a2x,a2y)与中心圆(b1x,b1y)连线的中心作为控制点，另一条线同理。</p>
<div style="max-width:500px;">![定贝塞尔曲线控制点](http://storyincafe.com/blogpics/drag-a-ball-6.jpg)</div>

<p>注意，可以看到最后呈现出来的曲线并不是如图通过三点的白色曲线，那是因为贝塞尔曲线并不是简单的三点连线，实则上不会经过控制点，这三点最后确定的点就是如图橙色的曲边。</p>
<p>确定了三个点，于是就可以画线了：</p>
<figure class="highlight"><pre><font face="monospace">
// &#x8BA1;&#x7B97;&#x63A7;&#x5236;&#x70B9;
var c1x = (a2x + b1x) / 2;
var c1y = (a2y + b1y) / 2;

// &#x5148;&#x79FB;&#x5230;&#x5F00;&#x59CB;&#x70B9;
context.moveTo(a1x,a1y);

// &#x6839;&#x636E;&#x76EE;&#x6807;&#x70B9;&#x548C;&#x63A7;&#x5236;&#x70B9;&#x753B;&#x51FA;&#x8D1D;&#x585E;&#x5C14;&#x66F2;&#x7EBF;
context.quadraticCurveTo(c1x,c1y,b1x,b1y);
</font></pre></figure>

<p>看起来差不多了，然而在两圆中间曲线变化的时候发现速率还是不自然，是缺了点什么？</p>
<h4 id="方案3"><a href="#方案3" class="headerlink" title="方案3"></a>方案3</h4><p>我们开始假设拖动夹角固定为90度，但这是不符合拖动力度变化的，因此我们可以做一个优化，随着拖动距离越远，拖动夹角应该越小。注意，不能无限期地变小，需要有一个最低夹角。</p>
<div style="max-width:500px;">![拖动夹角示例图](http://storyincafe.com/blogpics/drag-a-ball-7.jpg)</div>

<p>于是在基础上加一点代码优化拖动：</p>
<figure class="highlight"><pre><font face="monospace">var base_angle = Math.PI;//&#x57FA;&#x51C6;&#x5F27;&#x5EA6;
var distance_angle = Math.PI / 800;//&#x51CF;&#x89D2;&#x529B;&#x5EA6;&#xFF0C;&#x6BCF;&#x79FB;&#x52A8;1px&#x8DDD;&#x79BB;&#x51CF;&#x5C11;&#x7684;&#x5F27;&#x5EA6;&#x503C;
var distance_angle_limit = Math.PI * 3/4;//&#x6700;&#x5C0F;&#x57FA;&#x51C6;&#x5F27;&#x5EA6;

var Bangle = base_angle - distance*distance_angle;
if(Bangle &lt; distance_angle_limit){
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;Bangle = distance_angle_limit;
}

// &#x56E0;&#x6B64;&#x4E24;&#x5706;&#x7684;&#x56DB;&#x4E2A;&#x5207;&#x70B9;&#x9700;&#x8981;&#x52A0;&#x51CF;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x504F;&#x79FB;&#x503C;
dis_x1 = Math.cos(Math.abs(Bangle/2-angle))*oRadius;
dis_y1 = Math.sin(Bangle/2-angle)*oRadius;
dis_x2 = Math.cos(Math.abs(Math.PI-Bangle/2-angle))*oRadius;
dis_y2 = Math.sin(Math.PI-Bangle/2-angle)*oRadius;
</font></pre></figure>

<blockquote>
<p>拖拽后DragEnd</p>
</blockquote>
<p>拖拽后就需要回弹小球，只需要记录这时候拖动球的圆心坐标，然后执行回弹函数就行了。</p>
<blockquote>
<p>回弹动画</p>
</blockquote>
<p>回弹动画使用了<a href="https://github.com/tweenjs/tween.js" target="_blank" rel="noopener">Tween.js</a>，只需要定义好开始的位置（拖动球圆心）以及目标位置（中心圆圆心），选择合适的动画缓动函数，再更新动画函数<code>bounceUpdate</code>即可。</p>
<figure class="highlight"><pre><font face="monospace">// &#x9009;&#x62E9;&#x7F13;&#x52A8;&#x51FD;&#x6570;
var bounce_animate_type = TWEEN.Easing.Elastic.Out;

// &#x8C03;&#x7528;Tween.js&#xFF0C;&#x58F0;&#x660E;&#x5F00;&#x59CB;&#x548C;&#x7ED3;&#x675F;&#x4F4D;&#x7F6E;&#x3002;
coords = { x: last_x, y: last_y };
tween = new TWEEN.Tween(coords)
&#xA0;&#xA0;&#xA0;&#xA0;.to({ x: oX, y: oY }, bounce_duration_time)
&#xA0;&#xA0;&#xA0;&#xA0;.easing(bounce_animate_type)
&#xA0;&#xA0;&#xA0;&#xA0;.onUpdate(bounceUpdate)
&#xA0;&#xA0;&#xA0;&#xA0;.start();

bounceAnimate();

// RAF&#x786E;&#x4FDD;&#x52A8;&#x753B;&#x6D41;&#x7545;&#x8FD0;&#x884C;
function bounceAnimate(time) {
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;requestAnimationFrame(bounceAnimate);
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;TWEEN.update(time);
}
</font></pre></figure>

<p>这里最关键是<code>bounceUpdate</code>函数，它的实现方法其实也很简单，与拖动球时Draging时候一样，但是x和y不再是手指触摸点，而是Tween.js计算的数值coords.x和coords.y。</p>
<figure class="highlight"><pre><font face="monospace">// &#x66F4;&#x65B0;&#x52A8;&#x753B;&#x51FD;&#x6570;
function bounceUpdate(){
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;// &#x8BE5;&#x65F6;&#x523B;&#x5F39;&#x884C;&#x4F4D;&#x7F6E;
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;x = coords.x;
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;y = coords.y;

&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;//&#x4E4B;&#x540E;&#x5C31;&#x8DDF;Draging&#x4E00;&#x6837;
}
</font></pre></figure>

<p>至此，整个拖拽返弹效果就实现了。</p>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>偶尔写写教程贴也是一种消化过程呀，有问题欢迎留言。</p>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>tqtan</h4>
    <p>UI开发工程师／腾讯WXG，喜欢玩技术，也喜欢拍照。</p>
</section>
      <section class="share">
    <h4>Contact me</h4>
    <a class="icon-instagram" title="Instagram:targetkiller_" href="http://instagram.com/targetkiller_" target="_blank">
    <span class="hidden">instagram</span>
    </a>
    <a class="icon-sina-weibo" title="新浪微博" href="http://weibo.com/targetkiller" target="_blank">
    <span class="hidden">weibo</span>
    </a>
    <a class="icon-facebook" title="facebook" target="_blank" href="https://www.facebook.com/tq.targetkiller">
    <span class="hidden">facebook</span>
    </a>
    <a class="icon-github" title="Github" target="_blank" href="https://github.com/targetkiller">
    <span class="hidden">facebook</span>
    </a>
</section>

    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <span class="icon-logo">•</span>
    
    <a class="older-posts" href="/2016/01/01/summary-2015/">
        2015年终总结 →
    </a>
    
</nav>

  <div id="comment" class="comments-area">
    <h4 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h4>
    
</div>

</main>


      
<footer class="site-footer">
  
  <a class="subscribe icon-feed" href="atom.xml"><span class="tooltip">Subscribe!</span></a>
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">TQ blog</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

      <script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>




  </div>
</div>

<nav  class="outer-nav top horizontal">

          <a class="icon-home"  href="/"><span>Home</span></a>

          <a class="icon-news"  href="/archive"><span>Archive</span></a>

          <a class="icon-image"  href="/images"><span>Images</span></a>

          <a class="icon-wiki"  href="/wiki/2014-10-28-wiki/"><span>Wiki</span></a>

          <a class="icon-Favorites"  href="/favorites"><span>Favorites</span></a>

          <a class="icon-mail"  href="/about/2014-09-11-mabao/"><span>Contact</span></a>

</nav>

</div>
</body>
</html>
